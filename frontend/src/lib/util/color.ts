import type { Tuple } from './array';
import chroma from "chroma-js";
import { leftPad } from './string';
import { assert } from './typed';

export class Color {
	static Category10 = [
		[0.12156862745098039, 0.4666666666666667, 0.7058823529411765],
		[1, 0.4980392156862745, 0.054901960784313725],
		[0.17254901960784313, 0.6274509803921569, 0.17254901960784313],
		[0.8392156862745098, 0.15294117647058825, 0.1568627450980392],
		[0.5803921568627451, 0.403921568627451, 0.7411764705882353],
		[0.5490196078431373, 0.33725490196078434, 0.29411764705882354],
		[0.8901960784313725, 0.4666666666666667, 0.7607843137254902],
		[0.4980392156862745, 0.4980392156862745, 0.4980392156862745],
		[0.7372549019607844, 0.7411764705882353, 0.13333333333333333],
		[0.09019607843137255, 0.7450980392156863, 0.8117647058823529]
	].map(([r, g, b]) => new Color(r, g, b));

	r: number;
	g: number;
	b: number;

	constructor(r: number, g: number, b: number) {
		this.r = r;
		this.g = g;
		this.b = b;
	}

	static luma(l: number): Color {
		return new Color(l, l, l);
	}

	chroma() {
		return chroma(this.toString());
	}

	readable() {
		return this.brightness() > 0.5 ? new Color(0, 0, 0) : new Color(1, 1, 1);
	}

	brightness() {
		return this.r * 0.2126 + this.g * 0.7152 + this.b * 0.0722;
	}

	saturate(f: number) {
		let chromaColor = this.chroma().saturate(f);
		return new Color(...chromaColor.rgb().map((c: number) => c / 255) as Tuple<3, number>)
	}

	toString() {
		const { r, g, b } = this;
		const [ri, gi, bi] = [r, g, b].map((comp) => Math.floor(comp * 255));
		const n = ri * 256 * 256 + gi * 256 + bi;
		return '#' + leftPad(n.toString(16), '0', 6);
	}

	rgb(): Tuple<3, number> {
		const { r, g, b } = this;
		return [Math.floor(r * 255), Math.floor(g * 255), Math.floor(b * 255)];
	}

	lerp(other: Color, t: number): Color {
		return new Color(
			this.r + (other.r - this.r) * t,
			this.g + (other.g - this.g) * t,
			this.b + (other.b - this.b) * t
		);
	}
}

export class Gradient {
	static Viridis = new Gradient(
		[
			[3, 5, 26],
			[4, 5, 26],
			[5, 6, 27],
			[6, 7, 28],
			[7, 7, 29],
			[8, 8, 30],
			[10, 9, 31],
			[11, 9, 32],
			[13, 10, 33],
			[14, 11, 34],
			[16, 11, 35],
			[17, 12, 36],
			[19, 13, 37],
			[20, 14, 38],
			[22, 14, 39],
			[23, 15, 40],
			[24, 15, 41],
			[26, 16, 42],
			[27, 17, 43],
			[29, 17, 44],
			[30, 18, 45],
			[32, 18, 46],
			[33, 19, 48],
			[34, 19, 49],
			[36, 20, 50],
			[37, 20, 51],
			[39, 21, 52],
			[40, 21, 53],
			[42, 22, 54],
			[43, 22, 55],
			[45, 23, 56],
			[46, 23, 57],
			[48, 23, 58],
			[49, 24, 59],
			[51, 24, 60],
			[52, 25, 61],
			[53, 25, 62],
			[55, 25, 63],
			[56, 26, 64],
			[58, 26, 65],
			[60, 26, 66],
			[61, 26, 66],
			[63, 27, 67],
			[64, 27, 68],
			[66, 27, 69],
			[67, 28, 70],
			[69, 28, 71],
			[70, 28, 72],
			[72, 28, 72],
			[73, 29, 73],
			[75, 29, 74],
			[76, 29, 75],
			[78, 29, 75],
			[80, 29, 76],
			[81, 30, 77],
			[83, 30, 77],
			[84, 30, 78],
			[86, 30, 79],
			[88, 30, 79],
			[89, 30, 80],
			[91, 30, 81],
			[92, 30, 81],
			[94, 31, 82],
			[96, 31, 82],
			[97, 31, 83],
			[99, 31, 83],
			[100, 31, 84],
			[102, 31, 84],
			[104, 31, 85],
			[105, 31, 85],
			[107, 31, 86],
			[109, 31, 86],
			[110, 31, 87],
			[112, 31, 87],
			[113, 31, 87],
			[115, 31, 88],
			[117, 31, 88],
			[118, 31, 88],
			[120, 31, 89],
			[122, 31, 89],
			[123, 31, 89],
			[125, 31, 90],
			[127, 30, 90],
			[129, 30, 90],
			[130, 30, 90],
			[132, 30, 90],
			[134, 30, 91],
			[135, 30, 91],
			[137, 30, 91],
			[139, 29, 91],
			[140, 29, 91],
			[142, 29, 91],
			[144, 29, 91],
			[146, 28, 91],
			[147, 28, 91],
			[149, 28, 91],
			[151, 28, 91],
			[152, 27, 91],
			[154, 27, 91],
			[156, 27, 91],
			[158, 26, 91],
			[159, 26, 91],
			[161, 26, 91],
			[163, 25, 91],
			[164, 25, 91],
			[166, 25, 90],
			[168, 24, 90],
			[170, 24, 90],
			[171, 24, 90],
			[173, 23, 89],
			[175, 23, 89],
			[176, 23, 89],
			[178, 23, 88],
			[180, 22, 88],
			[181, 22, 87],
			[183, 22, 87],
			[185, 22, 87],
			[186, 22, 86],
			[188, 22, 86],
			[189, 22, 85],
			[191, 22, 84],
			[193, 23, 84],
			[194, 23, 83],
			[196, 23, 83],
			[197, 24, 82],
			[199, 25, 81],
			[200, 25, 81],
			[202, 26, 80],
			[203, 27, 79],
			[205, 28, 78],
			[206, 29, 78],
			[207, 30, 77],
			[209, 31, 76],
			[210, 32, 76],
			[211, 33, 75],
			[213, 34, 74],
			[214, 36, 73],
			[215, 37, 73],
			[216, 39, 72],
			[217, 40, 71],
			[219, 41, 70],
			[220, 43, 70],
			[221, 44, 69],
			[222, 46, 68],
			[223, 47, 68],
			[224, 49, 67],
			[225, 51, 66],
			[226, 52, 66],
			[227, 54, 65],
			[228, 56, 65],
			[229, 57, 64],
			[230, 59, 64],
			[231, 61, 63],
			[232, 63, 63],
			[232, 64, 62],
			[233, 66, 62],
			[234, 68, 62],
			[235, 70, 62],
			[235, 72, 62],
			[236, 74, 62],
			[236, 76, 62],
			[237, 78, 62],
			[237, 80, 62],
			[238, 82, 63],
			[238, 84, 63],
			[239, 86, 64],
			[239, 88, 64],
			[239, 90, 65],
			[240, 92, 66],
			[240, 94, 66],
			[240, 96, 67],
			[241, 98, 68],
			[241, 100, 69],
			[241, 102, 70],
			[242, 103, 71],
			[242, 105, 72],
			[242, 107, 73],
			[242, 109, 75],
			[242, 111, 76],
			[243, 113, 77],
			[243, 115, 78],
			[243, 116, 80],
			[243, 118, 81],
			[243, 120, 82],
			[244, 122, 84],
			[244, 124, 85],
			[244, 125, 87],
			[244, 127, 88],
			[244, 129, 90],
			[244, 131, 91],
			[244, 132, 93],
			[244, 134, 94],
			[245, 136, 96],
			[245, 138, 97],
			[245, 139, 99],
			[245, 141, 100],
			[245, 143, 102],
			[245, 144, 103],
			[245, 146, 105],
			[245, 148, 107],
			[245, 150, 108],
			[245, 151, 110],
			[245, 153, 112],
			[246, 155, 113],
			[246, 156, 115],
			[246, 158, 117],
			[246, 160, 119],
			[246, 161, 120],
			[246, 163, 122],
			[246, 164, 124],
			[246, 166, 126],
			[246, 168, 128],
			[246, 169, 129],
			[246, 171, 131],
			[246, 173, 133],
			[246, 174, 135],
			[246, 176, 137],
			[246, 177, 139],
			[246, 179, 141],
			[246, 180, 143],
			[246, 182, 145],
			[246, 184, 147],
			[246, 185, 149],
			[246, 187, 151],
			[246, 188, 153],
			[246, 190, 155],
			[246, 191, 157],
			[246, 193, 159],
			[247, 194, 162],
			[247, 196, 164],
			[247, 198, 166],
			[247, 199, 168],
			[247, 201, 170],
			[247, 202, 172],
			[247, 204, 175],
			[247, 205, 177],
			[247, 207, 179],
			[247, 208, 181],
			[248, 209, 184],
			[248, 211, 186],
			[248, 212, 188],
			[248, 214, 190],
			[248, 215, 192],
			[248, 217, 195],
			[248, 218, 197],
			[248, 220, 199],
			[249, 221, 201],
			[249, 223, 203],
			[249, 224, 205],
			[249, 226, 208],
			[249, 227, 210],
			[249, 229, 212],
			[250, 230, 214],
			[250, 232, 216],
			[250, 233, 218],
			[250, 235, 221]
		].map(([r, g, b]) => new Color(r / 256, g / 256, b / 256))
	);

	stops: Color[];

	constructor(stops: Color[]) {
		this.stops = stops;
	}

	sample(t: number) {
		assert(!Number.isNaN(t), 'value is nan');
		assert(0 <= t && t <= 1, 'value not in range');
		const leftIndex = Math.floor((this.stops.length - 2) * t);
		const rightIndex = Math.floor((this.stops.length - 2) * t + 1);
		const [leftColor, rightColor] = [leftIndex, rightIndex].map((index) => this.stops[index]);
		const leftWeight = t % (1 / this.stops.length);
		const rightWeight = 1 - leftWeight;
		return new Color(
			leftColor.r * leftWeight + rightColor.r * rightWeight,
			leftColor.g * leftWeight + rightColor.g * rightWeight,
			leftColor.b * leftWeight + rightColor.b * rightWeight
		);
	}

	reverse() {
		return new Gradient(this.stops.slice().reverse());
	}

	css(direction: string = 'to right'): string {
		let string = `linear-gradient(${direction}, `;
		string += this.stops.join(', ');
		string += ')';
		return string;
	}
}
